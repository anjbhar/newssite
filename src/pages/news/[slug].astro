---
import Layout from '../../layouts/Layout.astro';
import { sanityClient } from 'sanity:client';
import { PortableText } from 'astro-portabletext';
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';

interface Post {
  title: string;
  slug: { current: string };
  publishedAt: string;
  image?: SanityImageSource;
  body: any;
  author?: string;
  category?: string;
}

const { slug } = Astro.params;
const article = await sanityClient.fetch<Post>(`*[_type == "post" && slug.current == $slug][0]`, { slug });

if (!article) {
  return Astro.redirect('/404');
}

const builder = imageUrlBuilder(sanityClient);
function urlFor(source: SanityImageSource) {
	return builder.image(source);
}
---

<Layout title={article.title}>
    <div class="relative">
        <!-- Back to News link for mobile -->
        <a href="/" class="flex items-center mb-4 text-blue-500 hover:underline">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Back to News
        </a>

        <article class="max-w-3xl mx-auto">
            <h1 class="text-4xl font-bold mb-4">{article.title}</h1>
            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400 mb-8">
                {article.author && <span>{article.author}</span>}
                {article.author && <span class="mx-2">&#8226;</span>}
                <span>{new Date(article.publishedAt).toLocaleString([], {year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute:'2-digit'})}</span>
                {article.category && <span class="mx-2">&#8226;</span>}
                {article.category && <span class="bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">{article.category}</span>}
            </div>
            {article.image && (
                <img src={urlFor(article.image).url()} alt={article.title} class="w-full h-96 object-cover rounded-lg mb-8" />
            )}
            <div class="prose dark:prose-invert max-w-none">
                <PortableText value={article.body} />
            </div>
        </article>
    </div>
</Layout>
